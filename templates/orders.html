{% extends "base.html" %}

{% block title %}Orders - Caf√© Face Recognition System{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1><i class="fas fa-shopping-cart"></i> Orders</h1>
    <a href="{{ url_for('create_order') }}" class="btn btn-success">
        <i class="fas fa-plus-circle"></i> Create New Order
    </a>
</div>

{% if orders %}
<div class="card">
    <div class="card-header">
        <h5><i class="fas fa-list"></i> Recent Orders</h5>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover">
                <thead class="table-dark">
                    <tr>
                        <th>Order ID</th>
                        <th>Customer</th>
                        <th>Date</th>
                        <th>Items</th>
                        <th>Total Amount</th>
                        <th>Notes</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for order in orders %}
                    <tr>
                        <td>
                            <span class="badge bg-primary">#{{ order.id }}</span>
                        </td>
                        <td>
                            <strong>{{ order.customer_name }}</strong>
                        </td>
                        <td>
                            <small class="text-muted">
                                {{ order.order_date.split('T')[0] if 'T' in order.order_date else order.order_date }}
                                <br>
                                {{ order.order_date.split('T')[1].split('.')[0] if 'T' in order.order_date else '' }}
                            </small>
                        </td>
                        <td>
                            <div class="d-flex flex-wrap gap-1">
                                {% for item in order.items %}
                                <span class="badge bg-light text-dark">
                                    {{ item.quantity }}x {{ item.item_name }}
                                </span>
                                {% endfor %}
                            </div>
                            <small class="text-muted">{{ order.items|length }} item(s)</small>
                        </td>
                        <td>
                            <strong class="text-success">${{ "%.2f"|format(order.total_amount) }}</strong>
                        </td>
                        <td>
                            {% if order.notes %}
                                <small class="text-muted">{{ order.notes[:50] }}{% if order.notes|length > 50 %}...{% endif %}</small>
                            {% else %}
                                <small class="text-muted">No notes</small>
                            {% endif %}
                        </td>
                        <td>
                            <div class="btn-group btn-group-sm" role="group">
                                <button type="button" class="btn btn-outline-info" onclick="viewOrderDetails({{ order.id }})" title="View Details">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button type="button" class="btn btn-outline-success" onclick="reorderItems({{ order.id }})" title="Reorder">
                                    <i class="fas fa-redo"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Order Statistics -->
<div class="row mt-4">
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h4 class="text-primary">{{ orders|length }}</h4>
                <small class="text-muted">Total Orders</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h4 class="text-success">${{ "%.2f"|format(orders|sum(attribute='total_amount')) }}</h4>
                <small class="text-muted">Total Revenue</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h4 class="text-info">${{ "%.2f"|format((orders|sum(attribute='total_amount')) / (orders|length) if orders|length > 0 else 0) }}</h4>
                <small class="text-muted">Average Order</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h4 class="text-warning">{{ (orders|map(attribute='items')|list|flatten|length) }}</h4>
                <small class="text-muted">Total Items</small>
            </div>
        </div>
    </div>
</div>

{% else %}
<div class="text-center">
    <div class="card">
        <div class="card-body py-5">
            <i class="fas fa-shopping-cart fa-5x text-muted mb-4"></i>
            <h3>No orders yet</h3>
            <p class="text-muted">Start by creating your first order for a customer.</p>
            <a href="{{ url_for('create_order') }}" class="btn btn-success btn-lg">
                <i class="fas fa-plus-circle"></i> Create First Order
            </a>
        </div>
    </div>
</div>
{% endif %}

<!-- Order Details Modal -->
<div class="modal fade" id="orderDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-receipt"></i> Order Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="orderDetailsBody">
                <!-- Order details will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-success" onclick="reorderFromModal()">
                    <i class="fas fa-redo"></i> Reorder
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentOrderId = null;

function viewOrderDetails(orderId) {
    currentOrderId = orderId;
    
    // Find the order in the current page data
    const orderRow = document.querySelector(`tr:has(span:contains("#${orderId}"))`);
    if (!orderRow) {
        alert('Order details not found');
        return;
    }
    
    // Extract order information from the table row
    const cells = orderRow.cells;
    const customerName = cells[1].querySelector('strong').textContent;
    const orderDate = cells[2].textContent.trim();
    const totalAmount = cells[4].querySelector('strong').textContent;
    const notes = cells[5].textContent.trim();
    
    // Get items from the row
    const itemBadges = cells[3].querySelectorAll('.badge');
    let itemsHtml = '';
    
    itemBadges.forEach(badge => {
        const itemText = badge.textContent.trim();
        if (itemText !== `${itemBadges.length} item(s)`) {
            itemsHtml += `<li class="list-group-item">${itemText}</li>`;
        }
    });
    
    // Populate modal
    document.getElementById('orderDetailsBody').innerHTML = `
        <div class="row">
            <div class="col-md-6">
                <h6>Order Information</h6>
                <p><strong>Order ID:</strong> #${orderId}</p>
                <p><strong>Customer:</strong> ${customerName}</p>
                <p><strong>Date:</strong> ${orderDate}</p>
                <p><strong>Total:</strong> ${totalAmount}</p>
            </div>
            <div class="col-md-6">
                <h6>Notes</h6>
                <p>${notes === 'No notes' ? 'No notes provided' : notes}</p>
            </div>
        </div>
        
        <h6 class="mt-3">Order Items</h6>
        <ul class="list-group">
            ${itemsHtml || '<li class="list-group-item">No items found</li>'}
        </ul>
    `;
    
    new bootstrap.Modal(document.getElementById('orderDetailsModal')).show();
}

function reorderItems(orderId) {
    if (confirm('Create a new order with the same items?')) {
        // In a real implementation, this would redirect to create order page with pre-filled items
        window.location.href = `/create_order?reorder=${orderId}`;
    }
}

function reorderFromModal() {
    if (currentOrderId) {
        reorderItems(currentOrderId);
    }
}

// Add some interactivity to the table
document.addEventListener('DOMContentLoaded', function() {
    // Add hover effects to table rows
    const tableRows = document.querySelectorAll('tbody tr');
    tableRows.forEach(row => {
        row.addEventListener('mouseenter', function() {
            this.style.backgroundColor = '#f8f9fa';
        });
        
        row.addEventListener('mouseleave', function() {
            this.style.backgroundColor = '';
        });
    });
    
    // Add click to view details
    tableRows.forEach(row => {
        row.addEventListener('click', function(e) {
            // Don't trigger if clicking on action buttons
            if (!e.target.closest('.btn-group')) {
                const orderIdElement = this.querySelector('.badge');
                if (orderIdElement) {
                    const orderId = orderIdElement.textContent.replace('#', '');
                    viewOrderDetails(orderId);
                }
            }
        });
        
        // Add cursor pointer
        row.style.cursor = 'pointer';
    });
});

// Filter and search functionality
function filterOrders() {
    const searchInput = document.getElementById('orderSearch');
    const filterSelect = document.getElementById('orderFilter');
    
    if (!searchInput || !filterSelect) return;
    
    const searchTerm = searchInput.value.toLowerCase();
    const filterValue = filterSelect.value;
    
    const tableRows = document.querySelectorAll('tbody tr');
    
    tableRows.forEach(row => {
        const customerName = row.cells[1].textContent.toLowerCase();
        const orderDate = row.cells[2].textContent.toLowerCase();
        const items = row.cells[3].textContent.toLowerCase();
        
        const matchesSearch = customerName.includes(searchTerm) || 
                            orderDate.includes(searchTerm) || 
                            items.includes(searchTerm);
        
        let matchesFilter = true;
        if (filterValue === 'today') {
            const today = new Date().toISOString().split('T')[0];
            matchesFilter = orderDate.includes(today);
        } else if (filterValue === 'week') {
            // Simple week filter - could be improved
            const weekAgo = new Date();
            weekAgo.setDate(weekAgo.getDate() - 7);
            const orderDateObj = new Date(row.cells[2].textContent.trim().split(' ')[0]);
            matchesFilter = orderDateObj >= weekAgo;
        }
        
        row.style.display = (matchesSearch && matchesFilter) ? '' : 'none';
    });
}
</script>

<!-- Add search and filter controls -->
<style>
.order-controls {
    background: white;
    padding: 1rem;
    border-radius: 0.5rem;
    margin-bottom: 1rem;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

tbody tr {
    transition: background-color 0.2s ease;
}

.table td {
    vertical-align: middle;
}

.badge {
    font-size: 0.75em;
}

@media (max-width: 768px) {
    .table-responsive {
        font-size: 0.9em;
    }
    
    .btn-group-sm .btn {
        padding: 0.25rem 0.5rem;
    }
}
</style>

<!-- Search and Filter Controls -->
{% if orders %}
<div class="order-controls">
    <div class="row">
        <div class="col-md-6">
            <label for="orderSearch" class="form-label">Search Orders</label>
            <input type="text" class="form-control" id="orderSearch" placeholder="Search by customer, date, or items..." oninput="filterOrders()">
        </div>
        <div class="col-md-3">
            <label for="orderFilter" class="form-label">Filter by Date</label>
            <select class="form-select" id="orderFilter" onchange="filterOrders()">
                <option value="all">All Orders</option>
                <option value="today">Today</option>
                <option value="week">This Week</option>
                <option value="month">This Month</option>
            </select>
        </div>
        <div class="col-md-3">
            <label class="form-label">&nbsp;</label>
            <div class="d-grid">
                <button class="btn btn-outline-secondary" onclick="exportOrders()">
                    <i class="fas fa-download"></i> Export
                </button>
            </div>
        </div>
    </div>
</div>

<script>
function exportOrders() {
    // Simple CSV export functionality
    const rows = document.querySelectorAll('tbody tr:not([style*="display: none"])');
    let csv = 'Order ID,Customer,Date,Items,Total,Notes\n';
    
    rows.forEach(row => {
        const cells = row.cells;
        const orderId = cells[0].textContent.trim().replace('#', '');
        const customer = cells[1].textContent.trim();
        const date = cells[2].textContent.trim().replace(/\n/g, ' ');
        const items = cells[3].textContent.trim().replace(/\n/g, ' ');
        const total = cells[4].textContent.trim();
        const notes = cells[5].textContent.trim();
        
        csv += `"${orderId}","${customer}","${date}","${items}","${total}","${notes}"\n`;
    });
    
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `orders_${new Date().toISOString().split('T')[0]}.csv`;
    a.click();
    window.URL.revokeObjectURL(url);
}
</script>
{% endif %}
{% endblock %}
