{% extends "base.html" %}

{% block title %}Live Recognition - Caf√© Face Recognition System{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1><i class="fas fa-camera-retro"></i> Live Face Recognition</h1>
    <div>
        <button id="startBtn" class="btn btn-success">
            <i class="fas fa-play"></i> Start Recognition
        </button>
        <button id="stopBtn" class="btn btn-danger" style="display: none;">
            <i class="fas fa-stop"></i> Stop Recognition
        </button>
    </div>
</div>

<div class="row">
    <!-- Camera Feed -->
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-video"></i> Camera Feed</h5>
            </div>
            <div class="card-body text-center">
                <div id="cameraContainer">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        Click "Start Recognition" to begin face detection. 
                        Make sure your camera is connected and permissions are granted.
                    </div>
                </div>
                
                <!-- Video stream -->
                <div id="videoContainer" style="display: none;">
                    <img id="videoStream" src="" style="max-width: 100%; height: auto; border-radius: 8px;" />
                </div>
                
                <!-- Placeholder for camera feed -->
                <div id="cameraPlaceholder" style="min-height: 400px; background-color: #f8f9fa; border: 2px dashed #dee2e6; display: flex; align-items: center; justify-content: center;">
                    <div class="text-muted">
                        <i class="fas fa-camera fa-5x mb-3"></i>
                        <p>Camera feed will appear here</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Recognition Results -->
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-user-check"></i> Recognition Results</h5>
            </div>
            <div class="card-body">
                <div id="recognitionResults">
                    <div class="text-center text-muted">
                        <i class="fas fa-search fa-3x mb-3"></i>
                        <p>No customers detected yet</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Quick Actions -->
        <div class="card mt-3">
            <div class="card-header">
                <h5><i class="fas fa-bolt"></i> Quick Actions</h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <button class="btn btn-primary" onclick="createOrder()">
                        <i class="fas fa-shopping-cart"></i> Create Order
                    </button>
                    <button class="btn btn-info" onclick="viewRecommendations()">
                        <i class="fas fa-lightbulb"></i> View Recommendations
                    </button>
                    <button class="btn btn-success" onclick="addNewCustomer()">
                        <i class="fas fa-user-plus"></i> Add New Customer
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Recognition Status -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-chart-line"></i> Recognition Status</h5>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-md-3">
                        <div class="border-end">
                            <h4 id="totalDetections" class="text-primary">0</h4>
                            <small class="text-muted">Total Detections</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="border-end">
                            <h4 id="recognizedCustomers" class="text-success">0</h4>
                            <small class="text-muted">Recognized Customers</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="border-end">
                            <h4 id="unknownFaces" class="text-warning">0</h4>
                            <small class="text-muted">Unknown Faces</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <h4 id="sessionTime" class="text-info">00:00</h4>
                        <small class="text-muted">Session Time</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal for Customer Details -->
<div class="modal fade" id="customerModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-user"></i> Customer Recognized</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="customerModalBody">
                <!-- Customer details will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="createOrderForCustomer()">
                    <i class="fas fa-shopping-cart"></i> Create Order
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let recognitionActive = false;
let sessionStartTime = null;
let currentCustomerId = null;
let detectionCounts = {
    total: 0,
    recognized: 0,
    unknown: 0
};

// Start recognition
document.getElementById('startBtn').addEventListener('click', function() {
    startRecognition();
});

// Stop recognition
document.getElementById('stopBtn').addEventListener('click', function() {
    stopRecognition();
});

function startRecognition() {
    fetch('/api/start_recognition', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'started') {
            recognitionActive = true;
            sessionStartTime = new Date();
            
            document.getElementById('startBtn').style.display = 'none';
            document.getElementById('stopBtn').style.display = 'inline-block';
            
            // Show video stream
            document.getElementById('cameraPlaceholder').style.display = 'none';
            document.getElementById('videoContainer').style.display = 'block';
            document.getElementById('videoStream').src = '/video_feed?' + new Date().getTime();
            
            // Update camera container
            document.getElementById('cameraContainer').innerHTML = `
                <div class="alert alert-success">
                    <i class="fas fa-check-circle"></i>
                    Recognition started! Looking for customers...
                </div>
            `;
            
            // Start session timer
            startSessionTimer();
            
            // Start polling for recognition results
            startRecognitionPolling();
        }
    })
    .catch(error => {
        console.error('Error starting recognition:', error);
        alert('Failed to start recognition. Please check camera connection.');
    });
}

function stopRecognition() {
    fetch('/api/stop_recognition', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'stopped') {
            recognitionActive = false;
            
            document.getElementById('startBtn').style.display = 'inline-block';
            document.getElementById('stopBtn').style.display = 'none';
            
            // Hide video stream
            document.getElementById('videoContainer').style.display = 'none';
            document.getElementById('cameraPlaceholder').style.display = 'flex';
            document.getElementById('videoStream').src = '';
            
            // Update camera container
            document.getElementById('cameraContainer').innerHTML = `
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    Recognition stopped. Click "Start Recognition" to resume.
                </div>
            `;
            
            // Reset results
            document.getElementById('recognitionResults').innerHTML = `
                <div class="text-center text-muted">
                    <i class="fas fa-search fa-3x mb-3"></i>
                    <p>No customers detected yet</p>
                </div>
            `;
        }
    })
    .catch(error => {
        console.error('Error stopping recognition:', error);
    });
}

function startSessionTimer() {
    if (!recognitionActive) return;
    
    setInterval(function() {
        if (!recognitionActive || !sessionStartTime) return;
        
        const now = new Date();
        const elapsed = Math.floor((now - sessionStartTime) / 1000);
        const minutes = Math.floor(elapsed / 60);
        const seconds = elapsed % 60;
        
        document.getElementById('sessionTime').textContent = 
            `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }, 1000);
}

function updateDetectionCounts() {
    document.getElementById('totalDetections').textContent = detectionCounts.total;
    document.getElementById('recognizedCustomers').textContent = detectionCounts.recognized;
    document.getElementById('unknownFaces').textContent = detectionCounts.unknown;
}

function showCustomerRecognized(customerId, customerName, confidence) {
    currentCustomerId = customerId;
    detectionCounts.total++;
    detectionCounts.recognized++;
    updateDetectionCounts();
    
    // Update recognition results
    document.getElementById('recognitionResults').innerHTML = `
        <div class="alert alert-success">
            <h5><i class="fas fa-user-check"></i> Customer Recognized!</h5>
            <p><strong>${customerName}</strong></p>
            <p>Confidence: ${(confidence * 100).toFixed(1)}%</p>
            <button class="btn btn-sm btn-primary" onclick="loadCustomerDetails(${customerId})">
                View Details
            </button>
        </div>
    `;
}

function showUnknownFace() {
    detectionCounts.total++;
    detectionCounts.unknown++;
    updateDetectionCounts();
    
    // Update recognition results
    document.getElementById('recognitionResults').innerHTML = `
        <div class="alert alert-warning">
            <h5><i class="fas fa-user-question"></i> Unknown Customer</h5>
            <p>Face detected but not recognized</p>
            <button class="btn btn-sm btn-success" onclick="addNewCustomer()">
                Add New Customer
            </button>
        </div>
    `;
}

function loadCustomerDetails(customerId) {
    fetch(`/api/customer_stats/${customerId}`)
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert('Error loading customer details: ' + data.error);
            return;
        }
        
        const customer = data.customer;
        const modalBody = document.getElementById('customerModalBody');
        
        modalBody.innerHTML = `
            <div class="row">
                <div class="col-md-6">
                    <h6>Customer Information</h6>
                    <p><strong>Name:</strong> ${customer.name}</p>
                    <p><strong>Email:</strong> ${customer.email || 'Not provided'}</p>
                    <p><strong>Phone:</strong> ${customer.phone || 'Not provided'}</p>
                    <p><strong>Total Visits:</strong> ${customer.visit_count}</p>
                </div>
                <div class="col-md-6">
                    <h6>Order Statistics</h6>
                    <p><strong>Total Orders:</strong> ${data.total_orders}</p>
                    <p><strong>Total Spent:</strong> $${data.total_spent.toFixed(2)}</p>
                    <p><strong>Average Order:</strong> $${data.average_order_value.toFixed(2)}</p>
                </div>
            </div>
            
            <h6 class="mt-3">Most Ordered Items</h6>
            <ul class="list-group">
                ${data.most_ordered_items.map(item => 
                    `<li class="list-group-item d-flex justify-content-between">
                        <span>${item[0]}</span>
                        <span class="badge bg-primary">${item[1]} orders</span>
                    </li>`
                ).join('')}
            </ul>
        `;
        
        new bootstrap.Modal(document.getElementById('customerModal')).show();
    })
    .catch(error => {
        console.error('Error loading customer details:', error);
        alert('Failed to load customer details');
    });
}

function createOrder() {
    if (currentCustomerId) {
        window.location.href = `/create_order?customer_id=${currentCustomerId}`;
    } else {
        window.location.href = '/create_order';
    }
}

function createOrderForCustomer() {
    if (currentCustomerId) {
        window.location.href = `/create_order?customer_id=${currentCustomerId}`;
    }
}

function viewRecommendations() {
    if (currentCustomerId) {
        window.location.href = `/customer/${currentCustomerId}`;
    } else {
        alert('Please recognize a customer first to view recommendations');
    }
}

function addNewCustomer() {
    window.location.href = '/add_customer';
}

function startRecognitionPolling() {
    if (!recognitionActive) return;
    
    // Poll for recognition results every 2 seconds
    const pollInterval = setInterval(function() {
        if (!recognitionActive) {
            clearInterval(pollInterval);
            return;
        }
        
        fetch('/api/get_latest_recognition')
        .then(response => response.json())
        .then(data => {
            if (data.recognized) {
                showCustomerRecognized(data.customer.id, data.customer.name, data.confidence);
                
                // Display recommendations
                if (data.recommendations && data.recommendations.length > 0) {
                    updateRecommendations(data.recommendations);
                }
            }
        })
        .catch(error => {
            console.error('Error polling recognition results:', error);
        });
    }, 2000);
}

function updateRecommendations(recommendations) {
    const resultsDiv = document.getElementById('recognitionResults');
    let recHtml = `
        <div class="alert alert-success">
            <h5><i class="fas fa-user-check"></i> Customer Recognized!</h5>
            <h6 class="mt-3"><i class="fas fa-lightbulb"></i> Recommended Items:</h6>
            <ul class="list-unstyled mb-0">
    `;
    
    recommendations.forEach(rec => {
        recHtml += `
            <li class="mb-2">
                <strong>${rec.item.name}</strong> - $${rec.item.price.toFixed(2)}
                <br><small class="text-muted">${rec.reason}</small>
            </li>
        `;
    });
    
    recHtml += `
            </ul>
        </div>
    `;
    
    resultsDiv.innerHTML = recHtml;
}

// Simulate recognition events for demo purposes
function simulateRecognitionEvents() {
    if (!recognitionActive) return;
    
    setTimeout(function() {
        if (recognitionActive) {
            // Simulate random recognition events
            if (Math.random() > 0.7) {
                showCustomerRecognized(1, "John Doe", 0.92);
            } else if (Math.random() > 0.5) {
                showUnknownFace();
            }
            
            // Schedule next event
            simulateRecognitionEvents();
        }
    }, Math.random() * 5000 + 2000); // Random delay between 2-7 seconds
}
</script>
{% endblock %}
